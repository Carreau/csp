name: Setup Caches
description: 'Ensure various caches are setup like homebrew, vcpkg, ccache, etc'

inputs:
  cibuildwheel:
    type: choice
    description: "cibuildwheel run"
    options:
      - 'cp38'
      - 'cp39'
      - 'cp310'
      - 'cp311'
    default: 'cp39'

runs:
  using: 'composite'
  steps:
    # Setup CCache
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2.12
      with:
        key: ccache-${{ runner.os }}-${{ runner.arch }}
        append-timestamp: false  # avoid excess caching

    - name: Setup ccache in shell
      shell: bash
      run: echo 'PATH=/usr/lib/ccache:/usr/local/opt/ccache/libexec:'"$PATH" >> $GITHUB_ENV
      if: ${{ runner.os != 'Windows' }}
      # TODO windows

    ################
    # Homebrew Cache
    - name: Setup homebrew cache
      uses: actions/cache@v4
      with:
          path: |
              ~/Library/Caches/Homebrew/*
              ~/Library/Caches/Homebrew/downloads/*
          key: brew-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('Makefile') }}
          restore-keys: brew-${{ runner.os }}-${{ runner.arch }}-
      if: ${{ runner.os == 'macOS' }}

    ################
    # vcpkg Cache
    - name: Setup vcpkg cache in shell
      shell: bash
      run: |
        mkdir -p $HOME/vcpkg_cache
        mkdir -p $HOME/vcpkg_download_cache
        echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/vcpkg_cache" >> $GITHUB_ENV
        echo "VCPKG_DOWNLOADS=$HOME/vcpkg_download_cache" >> $GITHUB_ENV
      if: ${{ runner.os != 'Windows' }}

    - name: Setup vcpkg cache
      uses: actions/cache@v4
      with:
        path: |
          $HOME/vcpkg_cache
          $HOME/vcpkg_download_cache
        key: vcpkg-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-${{ runner.os }}-${{ runner.arch }}-
      if: ${{ runner.os != 'Windows' }}
